<html>

<head>
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=yes"/>
  <script src="https://cdn.jsdelivr.net/npm/mathjs@6.2.3/dist/math.min.js" integrity="sha256-jnrFf6CiZ2veyKUaL7l7FHWW/ela8txaw/J7SVZzW5o=" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mini.css/3.0.1/mini-default.min.css" integrity="sha256-Tb0Wikpef+a1/IiQ0gXyT9PsM654/3hNHHdxMwEhBLA=" crossorigin="anonymous" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/7.2.0/highcharts.js" integrity="sha256-pWlJ6y5bcww1f1YFl+ak3DjzWUFtLTiy1u1amuLuSfA=" crossorigin="anonymous"></script>
  <script src="./model.js"></script>
  <script src="https://d3js.org/d3.v4.min.js"> 
  </script> 
  <script src= 
      "https://d3js.org/d3-color.v1.min.js"> 
  </script> 
  <script src= 
      "https://d3js.org/d3-interpolate.v1.min.js"> 
  </script> 
  <script src= 
      "https://d3js.org/d3- scale-chromatic.v1.min.js"> 
  </script> 
  <script>
    function onCloseIntro () {
      if (document.getElementById('dont-show-anymore').checked)
        document.cookie = 'dontShowIntro=true'
      return true
    }

    function showResult () {
      const distance = parseInt(document.getElementById('distance').value)
      const duration = parseInt(document.getElementById('duration').value)
      showResultBox(distance, duration)
      showFixedDistanceGraph(distance)
      showFixedTimeGraph(distance, duration)
      return false
    }

    function showResultBox (distance, duration) {
      const lines = []
      document.cookie=`distance=${distance}`
      document.cookie=`duration=${duration}`
      for (name in settings) {
        lines.push(`<strong>${ name }:</strong>&nbsp;${calculateRounded({ name, distance, duration })}&euro;`)
      }
      document.getElementById('result').innerHTML = lines.join('<br>')
    }

    function showGraph (series, id, titleText) {
      Highcharts.chart(id, {
        title: { text: titleText, useHTML: true },
        yAxis: { title: { text: 'Kost' } },
        legend: { useHTML: true, layout: 'vertical', align: 'right', verticalAlign: 'middle' },
        plotOptions: { series: { label: { connectorAllowed: false }, pointStart: 0 } },
        series,
        responsive: {
          rules: [{
            condition: { maxWidth: 500 },
            chartOptions: {
              legend: { layout: 'horizontal', align: 'center', verticalAlign: 'bottom'}
            }
          }]
        }
      });
    }

    function showFixedDistanceGraph (distance) {
      const series = []
      const now = new Date()
      now.setHours(7)
      now.setMinutes(0)
      now.setSeconds(0)
      now.setMilliseconds(0)
      Object.entries(settings).forEach(([name], i, array) => {
        const data = []
        const color = d3.interpolateRainbow(i/array.length) 
        if (settings[name].getKeyValues) {
          const extendedSeries = settings[name].getKeyValues({ 
            timeRange: [now.valueOf(), now.valueOf() + 24 * 60 * 60 * 1000 ],
            distanceRange: distance,
            variables: settings[name].variables 
          })
          data.push(...extendedSeries.map(([time, _, cost]) => ([time, cost])))
        } else {
          for (let duration = 0; duration < 24 * 60 ; duration += 5) data.push([now.valueOf() + duration * 60 * 1000, calculateRounded({ name, distance, duration })])
        }
        series.push({ name, data, color })
      })
      Highcharts.chart('fixedDistanceGraph', {
        title: { text: `Kost per tijd voor ${distance}&thinsp;km`, useHTML: true },
        yAxis: { title: { text: 'Kost' } },
        xAxis: { type: 'datetime' }, 
        legend: { useHTML: true, layout: 'vertical', align: 'right', verticalAlign: 'middle' },
        plotOptions: {
          series: { label: { connectorAllowed: false }, pointStart: 0 }
        },
        series,
        responsive: {
          rules: [{
            condition: {
              maxWidth: 500
            },
            chartOptions: {
              legend: {
                layout: 'horizontal',
                align: 'center',
                verticalAlign: 'bottom'
              }
            }
          }]
        }
      })
    }

    function showFixedTimeGraph (distance, duration) {
      const series = []
      const maxKm = duration / 60 * 120 // maximum 120 distance/h
      Object.entries(settings).forEach(([name], i, array) => {
        const data = []
        const color = d3.interpolateRainbow(i/array.length) 
        for (let distance = 0; distance <= maxKm; distance++) data.push(calculateRounded({ name, distance, duration }))
        series.push({ name, data, color })
      })
      showGraph(series, 'fixedTimeGraph', `Kost per afstand voor ${duration}&thinsp;min`)
    }

    window.onload = () => {
      if (0 <= document.cookie.indexOf('dontShowIntro=true'))
      document.getElementById('modal-control').removeAttribute('checked')
      const [_, distance] = document.cookie.match(/distance=(\d*)/) || []
      const [__, duration] = document.cookie.match(/duration=(\d*)/) || [] 
      if (distance) document.getElementById('distance').value = distance
      if (duration) document.getElementById('duration').value = duration
    }
  </script>
  <style>
    form { display: flex; flex-direction: column; }
    form > span { display: flex; flex-direction: row; align-items: baseline; }
    .buttons { flex-grow: 1; display: flex; justify-content: flex-end; }
    #distance, #duration { width: 5em; }
    @media screen and (min-width: 42rem) {
      #distance + label::after { content: "," }
      form { flex-direction: row; align-items: baseline; }
    }
  </style>
</head>
<html>
  <input type="checkbox" id="modal-control" class="modal" checked onclick="onCloseIntro()">
  <div>
    <div class="card">
      <p class="section">
        Vul hier de geplande afstand en tijd in.<br>
        Zo kan je berekenen wat een rit met &eacute;&eacute;n van de Gentse autodeelplatformen zal kosten!
      </p>
      <div class="container">
        <div class="input-group row">
          <label for="modal-control" class="button small primary col-sm-2">OK</label>
          <input type="checkbox" id="dont-show-anymore">
          <label for="dont-show-anymore">Niet meer tonen</label>
        </div>
      </div>
    </div>
  </div>
  <form>
    <span>  
      <label for="distance">afstand</label>
      <input type="number" id="distance" value="10" inputmode="decimal" pattern="[0-9]*" novalidate>
      <label for="distance">km</label>
    </span>
    <span>
      <label for="duration">gedurende</label>
      <input type="number" id="duration" value="15" inputmode="decimal" pattern="[0-9]*" novalidate>
      <label for="duration">minuten</label>
    </span>
    <span class="buttons">
      <input type="submit" id="modal-control" onclick="showResult(); return false" value="toon resultaat">
    </span>
  </form>

  <div id="result"></div>
  <div id="fixedDistanceGraph"></div>
  <div id="fixedTimeGraph"></div>

</html>
